C**********************************************************************C
C*                                                                    *C
C*                                                                    *C
C*        сCTAHOBKA COOTBETCTBхъ сгкOB х тPAцMEHTA KOHTсPA оO         *C
C*     T-KOOPдхHATE дкъ оAPAMETPхвECKOцO CокAиH-оPEдCTABкEHхъ KOHTсPA *C
C*                                                                    *C
C* оAPAMETPш: XY(N,2) - KOOPдхHATш TOвEK KOHTсPA (BXOд). HA BшXOдE -  *C
C*       CO CцкAфEHHшMх "BшаPOCAMх", ECкх CцкAфхBAHхE гAKAгшBAкOCэ.   *C
C*            T(I) - PACCTOъHхE OT TOвKх I дO оEPBOи TOвKх KOHTсPA    *C
C*       оO дсцE KOHTсPA, AооPOKCхMхPсEMOцO кOMAHOи, оPOXOдъыEи       *C
C*       вEPEг TOвKх (XY(I,1),XY(I,2)) (BшXOд)                        *C
C*            XK(NKNOT),YK(NKNOT)           - X,Y     KOOPдхHATш      *C
C*       сгкOB CокAиHA (BXOд).                                        *C
C*            TK(I) - T-KOOPдхHATA сгкA I,      PACCвхTшBAETCъ        *C
C*       оOCPEдCTBOM оPOEKTхPOBAHхъ сгкOB HA тPAцMEHT KOHTсPA.        *C
C*            NBEG,NEND - HOMEPA TOвEK, сKAгшBAчыхE HA HAвAкO х KOHEж *C
C*       MAKCхMAкэHOцO OTPEгKA тPAцMEHTA,KOTOPши кEфхT BHсTPх OTPEгKA,*C
C*       BKкчвAчыEцO оPOEKжхх сгкOB (оO T-KOOPдхHATE) (BшXOд)         *C
C*            NUSL,NUSR - вхCкO сгкOB, KOTOPшE оOCкE хX соOPъдOвхBAHхъ*C
C*       оO T-KOOPдхHATE, оOксвхBьEиCъ оPх оPOEKTхPOBAHхх сгкOB HA    *C
C*       KOHTсP, HE хMEчT TOвEK тPAцMEHTA, кEфAыхX MEфдс TAKхM сгкOM  *C
C*       х EцO COCEдOM, х HAXOдъTCъ "кEBEE" хкх "оPABEE" тPAцMEHTA    *C
C*            EPS - KPхTEPхи дкъ PGM CцкAфхBAHхъ BшаPOCOB.            *C
C*            NDOUBL - вхCкO сгкOB хMEчыхX хдEHTхвHсч T-KOOPдхHATс    *C
C*       оPOEKжхх хX HA тPAцMEHT KOHTсPA. B CксвAE, KOцдA оEPBши х    *C
C*       оOCкEдHхи сгкш COBоAдAчT C HAвAкэHOи TOвKOи гAMKHсTOцO       *C
C*       KOHTсPA (PABHOи KOHEвHOи), TO T-KOOPдхHATш щTхX сгкOB PAгкхв-*C
C*       Hш х NDOUBL HE тхKCхPсET щTO дсакхPOBAHхE сгкOB              *C
C*            IFLG=AB  -  соPABкъчыхи оAPAMETP :                      *C
C*              B=1 - CцкAфхBATэ KOOPдхHATш TOвEK тPAцMEHTA HEOаXOдхMO*C
C*              B=0 - TAKOи HEOаXOдхMOCTх HET                         *C
C*              A=1 - XK х YK HEOаXOдхMO соOPъдOвхTэ B COOTBETCTBхх C *C
C*       оOксвхBьEиCъ T-KOOPдхHATOи    оPOEKжхи щTOцO сгкA            *C
C*              A=0 - соOPъдOвхBATэ HE HAдO                           *C
C*              WK(MAX(N*3,2*NKNOT))-PAаOвхи MACCхB.HA BшXOдE -       *C
C*       KBAдPATш MхHхMAкэHшX PACCTOъHхи OT                           *C
C*               сгкOB дO тPAцMEHTA KOHTсPA                           *C
C*            IWK(I)     - жEкOвхCкEHHши MACCхB. HA BшXOдE - HOMEPю   *C
C*       сгкнб, сонпъднвеммше он бнгпюярюмхч TK. PAгMEPHOCTэ - NKNOT  *C
C*       ECкх IWK(I)<0, TO щTO сгEк (IABS(IWK(I)))                    *C
C*        BHE тPAцMEHTA KOHTсPA (CM OохCAHхE                          *C
C*       оAPAMETPOB NUSL,NUSR)                                        *C
C*            IRC - KOд BOгBPATA :                                    *C
C*                0 - HOPMAкэHOE гABEPьEHхE                           *C
C*                1 - дAHHшE HE AHAкхгхPOBAкхCэ HA HAкхвхE BшаPOCOB   *C
C*      оPх гAдAHхх TAKOцO AHAкхгA, T. K. вхCкO BшаPACOB > 25%        *C
C*                2 - оOPъдOK CкEдOBAHхъ оPOEKжхи сгкOB(TK) жхKкхвECKх*C
C*      HE COBоAдAET C оOPъдKOM CкEдOBAHхъ сгкOB                      *C
C*                3 - щKBхBAкEHTHO IRC=1&IRC=2                        *C
C*                4 - MAкO N (<7 оPх B=1 хкх <2 оPх B=0)              *C
C*                5 - NKNOT < 2                                       *C
C*                6 - HEBEPHO оOдцOTOBкEHш BXOдHшE MACCхBш дкъ        *C
C*      оPOцPAMMш CцкAфхBAHхъ BшаPOCOB ICSMOU                         *C
C*                7 - сгкш жхйкхвеяйх сонпъднвемш, мн с TK мер        *C
C*      лнмнрнммнцн пнярю                                             *C
C*                                                                    *C
C* AкцOPхTM: 1.CцкAфхBAчTCъ      BшаPOCш (ECкх щTO гAKAгAHO)          *C
C*           2.ECкх вхCкO BшаPOCOB > 25% - CцкAфхBAHхE HE оPOхгBOдхTCъ*C
C*           3.KOOPдхHATA TOвKх I CцкAфхBAETCъ, ECкх OHA OTKкOHъETCъ  *C
C*     OT CокAиH-KPхBOи >EPS*(T(I+3)-T(I-3))/6.                       *C
C*           4.оPOEKTхPсеM сгкш HA тPAцMEHT KOHTсPA, PACCвхTшBAъ х    *C
C*     соOPъдOвхBAъ TK,IWK,WK х XK,YK (ECкх TPEасETCъ). CвхTAEM NBEG, *C
C*     NEND,NUSL,NUSR х NDOUBL.                                       *C
C*                                                                    *C
C* оPхMEвAHхE: ECкх оPх оPOEKTхPOBAHхх соOPъдOвEHHшX PAHEE сгкOB HET  *C
C*             сBEPEHHOCTх B жхKкхвECKOM COBоAдEHхх оOPъдKA CкEдOBAHхъ*C
C*             хX оPOEKжхи, TO PEKOMEHдсETCъ BBOдхTэ B тPAцMEHT       *C
C*             KOHTсPA KOOPдхHATш сгкOB.                              *C
C*             TOвKх тPAцMEHTA HE дOкфHш COBоAдATэ, гA хCKкчвEHхEM    *C
C*             KPAиHхX TOвEK оPх гAMKHсTOM KOHTсPE                    *C
C*             оPEдоOкAцAETCъ оPх CцкAфхBAHхх, вTO оEPBшE х оOCкEдHхE *C
C*             3 TOвKх тPAцMEHTA HAXOдъTCъ HA CBOEM "хCTхHHOM" MECTE  *C
C*             (OцPAHхEвEHхE оPOцPAMMш ICSMOU)                        *C
C*             CMOTPхTE TAKфE KOMMEHTAPхх оPOцAMMш CONKN              *C
C*                                                                    *C
C*                                                                    *C
C**********************************************************************C
      SUBROUTINE TPREP(XY,T,N,XK,YK,TK,NKNOT,NBEG,NEND,NUSL,NUSR,NDOUBL,
     *EPS,WK,IWK,IFLG,IRC)
      REAL XY(N,2),T(N),XK(1),YK(1),TK(1),WK(N,3)
      INTEGER*2 IWK(NKNOT)
C		бШБНД ОЮПЮЛЕРПНБ ДКЪ ОПНЮЕПЙХ
      write(*,*) 'TPREP'
      open(18, FILE='tprep.log', action='write')
	write(18, *) '-------TPREP.LOG---------- '
	write(18, *) 'N =', N, ', NKNOT =', NKNOT
	write(18, *) 'XY T:'
	write(18, 1) (XY(I, 1), XY(I, 2), T(I), I = 1, N)
    1 format(3F12.4)
      close(18)
C
C*          оPOBEPKA KOPPEKTHOCTх BXOдHшX оAPAMETPOB
      IRC=4
      NMAX=2
      IF(IFLG-IFLG/2*2.EQ.1) NMAX=7
      IF(N.LT.NMAX) GO TO 300
      IRC=5
      IF(NKNOT.LT.2) GO TO 300
C*          гюлймср кх йнмрсп (б ялшяке он сгкюл) ?
      ICN=0
      IF(XK(1).EQ.XK(NKNOT).AND.YK(1).EQ.YK(NKNOT)) ICN=1
C*          PACвET PACCTOъHхи дO TOвEK кOMAHOи BдOкэ KOHTYPA
      T(1)=0.
      DO 10 I=2,N
      T(I)=T(I-1)+SQRT((XY(I,1)-XY(I-1,1))**2+(XY(I,2)-XY(I-1,2))**2)
10    CONTINUE
      IRC=0
      IF(IFLG-IFLG/2*2.EQ.0) GO TO 100
C
C*        AHAкхг дAHHшX HA BшаPOCш
C
      DO 20 I=1,N
      WK(I,1)=XY(I,1)
      WK(I,2)=XY(I,2)
20    WK(I,3)=T(I)
C*          CцкAфхBAEM  TOвKх оO KOOPдхHATE X
      CALL  ICSMOU(WK(1,3),WK,N,1.,EPS,N/4+1,WK(1,4),IER)
      IF(IER.NE.0) IRC=6
      IF(IRC.EQ.6) GO TO 300
C*          CцкAфхBAEM  TOвKх оO KOOPдхHATE Y
      CALL  ICSMOU(WK(1,3),WK(1,2),N,1.,EPS,N/4+1,WK(1,4),IER)
      IF(IER.NE.0) IRC=6
      IF(IRC.EQ.6) GO TO 300
C*            NVILD - вхCкO BшаPOCOB
      NVILD=0
      DO 30 I=1,N
      IF(WK(I,1).EQ.XY(I,1).AND.WK(I,2).EQ.XY(I,2)) GO TO 30
      NVILD=NVILD+1
30    CONTINUE
C
      IF(NVILD*4.GT.N) IRC=1
      IF(NVILD*4.GT.N.OR.NVILD.EQ.0) GO TO 100
C*          оEPECвET T
      DO 60 I=1,N
      DO 60 J=1,2
60    XY(I,J)=WK(I,J)
      T(1)=0.
      DO 70 I=2,N
70    T(I)=T(I-1)+SQRT((XY(I,1)-XY(I-1,1))**2+(XY(I,2)-XY(I-1,2))**2)
C
C*       PACвET TK,NBEG,NEND, х Tд.,  YоOPъдOвхBAHхE YгкOB B оOPъдKE
C*   BOгPACTAHхъ TK
C
100   CALL  CONKN(XY,XY(1,2),T,N,XK,YK,TK,NKNOT,NBEG,NEND,WK,IWK,NUSL,
     *NUSR,NDOUBL,IFLG/2)
      IF(ICN.EQ.1) NDOUBL=NDOUBL-1
      IF(NDOUBL.LT.0) NDOUBL=0
C*          оPOBEPKA HA жхKкхвECKсч соOPъдOвEHHOCTэ оPOEKжхи сгкOB
      ICU=-1
      I1=NKNOT
      NKBEG=0
      DO 110 I=1,NKNOT
      IF(IABS(IWK(I)).EQ.1) NKBEG=I-1
      IF(IABS(IWK(I)).NE.IABS(IWK(I1)+1).AND.IABS(IWK(I)).NE.1)
     * GO TO 120
      IF(IABS(IWK(I)).EQ.1.AND.IABS(IWK(I1)).NE.NKNOT) GO TO 120
      I1=I
110   CONTINUE
      ICU=0
      GO TO 130
C*          опнбепйю мю жхйкхвеяйх напюрмши онпъднй якеднбюмхъ сгкнб
120   I1=NKNOT
      ICU=-1
      NKBEG=0
      DO 125 I=1,NKNOT
      IF(IABS(IWK(I)).EQ.1) NKBEG=I-1
      IF(IABS(IWK(I)).NE.IABS(IWK(I1)-1).AND.IABS(IWK(I)).NE.NKNOT)
     * GO TO 127
      IF(IABS(IWK(I)).EQ.NKNOT.AND.IABS(IWK(I1)).NE.1) GO TO 127
      I1=I
125   CONTINUE
      ICU=1
      GO TO 130
127   IF(ICN.EQ.0) GO TO 130
C*           яокюим юоопнйяхлюжхх гюлймср. лемъел онпъднй якеднбюмхъ
C*    оепбнцн х онякедмецн сгкнб х бмнбэ опнбепъел мю жхйкхвеяйсч 
C*                     сонпъднвеммнярэ
      DO I=1,NKNOT
        IF(IABS(IWK(I)).EQ.1) NK1=I
        IF(IABS(IWK(I)).EQ.NKNOT) NKLAST=I
      END DO
      IWKS=IWK(NK1)
      IWK(NK1)=IWK(NKLAST)
      IWK(NKLAST)=IWKS
C*       опнбепъел: сгкш жхйкхвеяйх сонпъднвемш?
      ICU=-1
      I1=NKNOT
      NKBEG=0
      DO I=1,NKNOT
        IF(IABS(IWK(I)).EQ.1) NKBEG=I-1
        IF(IABS(IWK(I)).NE.IABS(IWK(I1)+1).AND.IABS(IWK(I)).NE.1)
     *   GO TO 128
        IF(IABS(IWK(I)).EQ.1.AND.IABS(IWK(I1)).NE.NKNOT) GO TO 128
      I1=I
      END DO
      ICU=0
      GO TO 130
C*          опнбепйю мю жхйкхвеяйх напюрмши онпъднй якеднбюмхъ сгкнб
128   I1=NKNOT
      ICU=-1
      NKBEG=0
      DO I=1,NKNOT
         IF(IABS(IWK(I)).EQ.1) NKBEG=I-1
         IF(IABS(IWK(I)).NE.IABS(IWK(I1)-1).AND.IABS(IWK(I)).NE.NKNOT)
     *   GO TO 130
         IF(IABS(IWK(I)).EQ.NKNOT.AND.IABS(IWK(I1)).NE.1) GO TO 130
         I1=I
      END DO
      ICU=1
C
130   IF(IFLG/2.EQ.1.AND.ICU.GE.0) GO TO 300
      IF(IFLG/2.EQ.1.AND.ICU.LT.0) GO TO 290
      IF(IABS(IWK(1)).EQ.1.AND.ICU.EQ.0) GO TO 300
C*          ашк гюйюг - сгкш ме сонпъднвхбюрэ. опхбндхл б яннрберярбхх
C*    я онпъдйнл якеднбюмхъ сгкнб люяяхбш TK,IWK,WK
C      
C*          янпрхпнбйю пюяярнъмхи
      DO I=1,NKNOT
        NU=IABS(IWK(I))
        WK(NU+NKNOT,1)=WK(I,1)
      END DO
C
      DO I=1,NKNOT
        WK(I,1)=WK(I+NKNOT,1)
      END DO
C*          сонпъднвхбел люяяхб TK
      TKMAX=0.
      DO I=1,NKNOT
        NU=IABS(IWK(I))
          IF(IWK(I).GT.0.AND.TKMAX.LT.TK(I)) TKMAX=TK(I)
        WK(NU+NKNOT,1)=TK(I)
      END DO
C
      DO I=1,NKNOT
        TK(I)=WK(I+NKNOT,1)
      END DO
C*           
      IF(ICU.LT.0) GO TO 290
      IF(ICU.EQ.0) GO TO 140
C*          сгкш "юмрхсонпъднвемш". опенапюгсел люяяхб рй
      DO I=1,NKNOT
        IF(IWK(I).GT.0) TK(I)=TKMAX-TK(I)
      END DO
      IRC=0
      IF(IABS(IWK(1)).EQ.1.AND.ICU.EQ.0) GO TO 300
C
140      IRC=7
      IF(XY(1,1).NE.XY(N,1).OR.XY(1,2).NE.XY(N,2)) GO TO 300
      IRC=0
C*          тпюцлемр йнмрспю гюлймср. оепеявхршбюел TK
      IF(ICU.EQ.1) GO TO  150
      DO I=1,NKBEG
        TK(NKNOT-I+1)=TK(NKNOT-I+1)+T(N)
      END DO
      GO TO 160
150   NKA=NKNOT-NKBEG-1
      IF(NKA.EQ.0) GO TO 160
C*          оепеявер рй дкъ юмрхсонпъднвеммшу сгкнб
      DO I=NKBEG+2,NKNOT
        TK(I)=T(N)+TK(I)
      END DO
C*          TK(1) -> 0
160   DO I=2,NKNOT
        TK(I)=TK(I)-TK(1)
      END  DO
      TK(1)=0.
      GO TO 300
C*      HET жхKкхвECKOи соOPъдOвEHHOCTх
290   IRC=IRC+2
300   RETURN
      END
